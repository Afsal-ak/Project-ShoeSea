<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        .checkout-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .address-card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .order-summary {
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        .btn-edit, .btn-delete {
            margin-top: 10px;
            margin-right: 5px;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .quantity-controls button {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }
        .quantity-controls input {
            width: 50px;
            text-align: center;
            margin: 0;
        }
        .order-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .order-summary-item .details {
            flex: 1;
            padding-right: 15px;
        }
        .order-summary-item .price {
            text-align: right;
        }
        .apply-coupon, .payment-method {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <%- include('../partials/user/header') %>
    <div class="container mt-4 checkout-container">
        <h2 class="mb-4">Checkout</h2>

        <!-- Address Selection -->
        <div class="mb-4">
            <h4>Select Delivery Address</h4>
            <form action="/place-order" method="POST">
                <% addresses.forEach(address => { %>
                    <div class="form-check address-card">
                        <input class="form-check-input" type="radio" name="addressId" value="<%= address._id %>" id="address<%= address._id %>" required>
                        <label class="form-check-label" for="address<%= address._id %>">
                            <strong><%= address.fname %> <%= address.lname %></strong><br>
                            <%= address.housename %>, <%= address.city %>, <%= address.state %>, <%= address.country %> - <%= address.pincode %><br>
                            Phone: <%= address.phone %>
                        </label>
                        <div class="mt-2">
                            <a href="/edit-address/<%= address._id %>" class="btn btn-secondary btn-sm btn-edit">Edit</a>
                            <a href="/delete-address/<%= address._id %>" class="btn btn-danger btn-sm btn-delete">Delete</a>
                        </div>
                    </div>
                <% }) %>

                <!-- Button to Add a New Address -->
                <a href="/add-address" class="btn btn-primary mb-3">Add New Address</a>

                <!-- Order Summary -->
                <div class="order-summary">
                    <h4>Order Summary</h4>
                    <% cart.forEach(item => { %>
                        <div class="order-summary-item">
                            <div class="details">
                                <p class="mb-1"><strong><%= item.product.productName %></strong></p>
                                <div class="quantity-controls">
                                    <!-- Decrement Button -->
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="adjustQuantity('<%= item._id %>', -1, <%= item.product.salePrice %>, <%= item.product.quantity %>)">-</button>

                                    <!-- Quantity Input -->
                                    <input type="number" value="<%= item.quantity %>" id="quantity<%= item._id %>" readonly>

                                    <!-- Increment Button -->
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="adjustQuantity('<%= item._id %>', 1, <%= item.product.salePrice %>, <%= item.product.quantity %>)">+</button>
                                </div>
                            </div>
                            <div class="price" id="price<%= item._id %>">
                                <p class="mb-0">Price: <strong>$<%= item.product.salePrice * item.quantity %></strong></p>
                            </div>
                        </div>
                    <% }) %>
                    <p class="mt-3"><strong>Total Amount: $<span id="totalAmount"><%= totalAmount %></span></strong></p>
                </div>

                <!-- Apply Coupon -->
                <div class="apply-coupon">
                    <h4>Apply Coupon</h4>
                    <input type="text" class="form-control" name="couponCode" placeholder="Enter coupon code">
                </div>

                <!-- Payment Method -->
                <div class="payment-method mt-3">
                    <h4>Payment Method</h4>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" value="cod" id="cod" checked>
                        <label class="form-check-label" for="cod">
                            Cash on Delivery
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" value="online" id="online">
                        <label class="form-check-label" for="online">
                            Online Payment
                        </label>
                    </div>
                </div>

                <!-- Place Order Button -->
                <button type="submit" class="btn btn-success mt-3">Place Order</button>
            </form>
        </div>
    </div>
    <%- include('../partials/user/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- <script>
        function adjustQuantity(itemId, adjustment, price, maxStock) {
            const quantityInput = document.getElementById(`quantity${itemId}`);
            if (!quantityInput) {
                console.error(`Quantity input for item ${itemId} not found.`);
                return;
            }
            
            let currentQuantity = parseInt(quantityInput.value);
            currentQuantity += adjustment;

            // Ensure the quantity does not go below 1 or above maxStock
            if (currentQuantity < 1) {
                currentQuantity = 1;
            } else if (currentQuantity > maxStock) {
                currentQuantity = maxStock;
            }

            quantityInput.value = currentQuantity;

            // Disable increment button if stock limit is reached
            const incrementButton = quantityInput.nextElementSibling;
            if (currentQuantity >= maxStock) {
                incrementButton.disabled = true;
            } else {
                incrementButton.disabled = false;
            }

            // Update item price
            const itemPrice = price * currentQuantity;
            const priceElement = document.getElementById(`price${itemId}`);
            if (!priceElement) {
                console.error(`Price element for item ${itemId} not found.`);
                return;
            }
            priceElement.innerHTML = `Price: <strong>$${itemPrice.toFixed(2)}</strong>`;

            // Update total amount
            updateTotalAmount();
        }

        function updateTotalAmount() {
            let totalAmount = 0;
            document.querySelectorAll('.order-summary-item').forEach(item => {
                const priceElement = item.querySelector('.price strong');
                if (priceElement) {
                    totalAmount += parseFloat(priceElement.innerText.replace('$', ''));
                }
            });

            document.getElementById('totalAmount').innerText = totalAmount.toFixed(2);
        }
    </script> -->
<script>
// Function to adjust quantity and update price
function adjustQuantity(itemId, adjustment, price, maxStock) {
    const quantityInput = document.getElementById(`quantity${itemId}`);
    const priceElement = document.getElementById(`price${itemId}`);
    
    if (!quantityInput || !priceElement) {
        console.error(`Elements for item ${itemId} not found.`);
        return;
    }
    
    let currentQuantity = parseInt(quantityInput.value);
    currentQuantity += adjustment;

    // Ensure the quantity does not go below 1 or above maxStock
    currentQuantity = Math.max(1, Math.min(currentQuantity, maxStock));

    quantityInput.value = currentQuantity;

    // Update item price
    const itemPrice = price * currentQuantity;
    priceElement.innerHTML = `Price: <strong>$${itemPrice.toFixed(2)}</strong>`;

    // Update buttons state
    updateButtonState(itemId, currentQuantity, maxStock);

    // Update total amount
    updateTotalAmount();
}

// Function to update button state based on quantity
function updateButtonState(itemId, quantity, maxStock) {
    const decrementButton = document.querySelector(`button[onclick*="adjustQuantity('${itemId}', -1"]`);
    const incrementButton = document.querySelector(`button[onclick*="adjustQuantity('${itemId}', 1"]`);

    if (decrementButton) decrementButton.disabled = quantity <= 1;
    if (incrementButton) incrementButton.disabled = quantity >= maxStock;
}

// Function to update total amount
function updateTotalAmount() {
    let totalAmount = 0;
    document.querySelectorAll('.order-summary-item').forEach(item => {
        const quantityInput = item.querySelector('input[type="number"]');
        const priceElement = item.querySelector('.price strong');
        if (quantityInput && priceElement) {
            const quantity = parseInt(quantityInput.value);
            const price = parseFloat(priceElement.innerText.replace('$', ''));
            totalAmount += price;
        }
    });

    const totalAmountElement = document.getElementById('totalAmount');
    if (totalAmountElement) {
        totalAmountElement.innerText = totalAmount.toFixed(2);
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Set up initial button states and total amount
    document.querySelectorAll('.order-summary-item').forEach(item => {
        const itemId = item.querySelector('input[type="number"]').id.replace('quantity', '');
        const quantity = parseInt(item.querySelector('input[type="number"]').value);
        const maxStock = parseInt(item.querySelector('button:last-child').getAttribute('onclick').match(/\d+/g).pop());
        updateButtonState(itemId, quantity, maxStock);
    });
    updateTotalAmount();
});
    </script>
</body>
</html>
