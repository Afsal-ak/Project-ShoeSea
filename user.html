<body>
    <%- include('../partials/user/header') %>

    <div class="container">
        <h2><i class="fas fa-shopping-cart"></i> Checkout</h2>

        <div class="checkout-grid">
            <div class="checkout-section">
                <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>

                <!-- Add Address Button -->
                <button class="add-address-btn" onclick="toggleAddressForm()">
                    <i class="fas fa-plus"></i> Add New Address
                </button>

                <!-- Address Form for Adding New Address -->
                <form id="addressForm" action="/add-address" method="POST">
                    <input type="text" name="fname" placeholder="First Name" required>
                    <input type="text" name="lname" placeholder="Last Name" required>
                    <input type="text" name="housename" placeholder="House Name/Number" required>
                    <input type="text" name="city" placeholder="City" required>
                    <input type="text" name="state" placeholder="State" required>
                    <input type="text" name="country" placeholder="Country" required>
                    <input type="number" name="pincode" placeholder="Pincode" required>
                    <input type="number" name="phone" placeholder="Phone" required>
                    <button type="submit" class="btn">Save Address</button>
                </form>

                <!-- Existing Addresses -->
                <% if (userAddress && userAddress.length > 0) { %>
                    <% userAddress.forEach((address, index) => { %>
                        <div class="address-card">
                            <input type="radio" name="selectedAddress" value="<%= address._id %>" onchange="updateSelectedAddress(this.value)">
                            <h4><%= address.fname %> <%= address.lname %></h4>
                            <p><%= address.housename %>, <%= address.city %>, <%= address.state %>, <%= address.country %> - <%= address.pincode %></p>
                            <p>Phone: <%= address.phone %></p>
                            <div class="address-actions">
                                <button class="edit-btn" onclick="window.location.href='/edit-address/<%= address._id %>'">Edit</button>
                                <button class="delete-btn" onclick="window.location.href='/delete-address/<%= address._id %>'">Delete</button>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p>No addresses found. Please add a new address.</p>
                <% } %>
            </div>

            <div class="checkout-section">
                <h3><i class="fas fa-file-invoice-dollar"></i> Order Summary</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (userCart.cart && userCart.cart.length > 0) { %>
                            <% userCart.cart.forEach(item => { %>
                                <tr>
                                    <td><%= item.productId.productName %></td>
                                    <td><%= item.quantity %></td>
                                    <td>$<%= item.productId.salePrice.toFixed(2) %></td>
                                    <td>$<%= (item.productId.salePrice * item.quantity).toFixed(2) %></td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="4">Your cart is empty.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>

                <div class="coupon-section">
                    <h4><i class="fas fa-tag"></i> Have a Coupon?</h4>
                    <% if (!coupon) { %>
                        <form action="/apply-coupon" method="POST">
                            <input type="text" name="couponCode" placeholder="Enter coupon code" required>
                            <button type="submit" class="btn">Apply</button>
                        </form>
                    <% } else { %>
                        <p class="success">Coupon "<%= coupon.code %>" applied! Discount: $<%= coupon.discountAmount.toFixed(2) %></p>
                        <form action="/remove-coupon" method="POST">
                            <button type="submit" class="btn btn-secondary">Remove Coupon</button>
                        </form>
                    <% } %>
                    <% if (error_msg) { %>
                        <p class="error"><%= error_msg %></p>
                    <% } %>
                </div>

                <div class="payment-method">
                    <h4><i class="fas fa-credit-card"></i> Select Payment Method</h4>
                    <form id="checkoutForm" method="POST" onsubmit="return validateAddressSelection()">
                        <div class="payment-options">
                            <label>
                                <input type="radio" name="paymentMethod" value="Cash on Delivery" checked>
                                Cash on Delivery
                            </label>
                            <label>
                                <input type="radio" name="paymentMethod" value="Razorpay">
                                Online Payment
                            </label>
                        </div>
                    
                        <input type="hidden" name="userId" value="<%= user._id %>">
                        <input type="hidden" name="totalAmount" value="<%= totalAmount - (coupon ? coupon.offerPrice : 0) %>">
                        <input type="hidden" name="totalQuantity" value="<%= userCart.cart.reduce((sum, item) => sum + item.quantity, 0) %>">
                        <input type="hidden" name="addressId" id="selectedAddressId" value="">
                    
                        <button type="submit" class="btn">Place Order</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <%- include('../partials/user/footer') %>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        function toggleAddressForm() {
            const form = document.getElementById('addressForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
    
        function updateSelectedAddress(addressId) {
            document.getElementById('selectedAddressId').value = addressId;
            document.querySelectorAll('.address-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`input[value="${addressId}"]`).closest('.address-card').classList.add('selected');
        }
    
        // async function handleRazorpayPayment(totalAmount) {
        //     const response = await fetch('/create-razorpay-order', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify({ totalAmount })
        //     });
        //     const { order_id } = await response.json();
    
        //     const options = {
        //         key: 'YOUR_RAZORPAY_KEY', // Your Razorpay key
        //         amount: totalAmount * 100, // Amount in paise
        //         currency: 'INR',
        //         name: 'Your Shop Name',
        //         description: 'Order Payment',
        //         order_id: order_id,
        //         handler: async function (response) {
        //             await fetch('/verify-razorpay-payment', {
        //                 method: 'POST',
        //                 headers: { 'Content-Type': 'application/json' },
        //                 body: JSON.stringify({
        //                     razorpay_payment_id: response.razorpay_payment_id,
        //                     razorpay_order_id: response.razorpay_order_id,
        //                     razorpay_signature: response.razorpay_signature
        //                 })
        //             });
                    
        //             await fetch('/checkout/online-payment', {
        //                 method: 'POST',
        //                 headers: { 'Content-Type': 'application/json' },
        //                 body: JSON.stringify({
        //                     razorpay_payment_id: response.razorpay_payment_id,
        //                     razorpay_order_id: response.razorpay_order_id,
        //                     razorpay_signature: response.razorpay_signature,
        //                     addressId: document.getElementById('selectedAddressId').value
        //                 })
        //             });

        //             window.location.href = '/order-success';
        //         },
        //         prefill: {
        //             name: 'Customer Name',
        //             email: 'customer@example.com',
        //             contact: '9999999999'
        //         },
        //         theme: {
        //             color: '#F37254'
        //         }
        //     };
    
        //     const paymentObject = new Razorpay(options);
        //     paymentObject.open();
        // }
//         async function handleRazorpayPayment(totalAmount) {
//     try {
//         const response = await fetch('/create-razorpay-order', {
//             method: 'POST',
//             headers: { 'Content-Type': 'application/json' },
//             body: JSON.stringify({ totalAmount })
//         });
//         const data = await response.json();
        
//         if (!data.success) {
//             throw new Error(data.message || 'Failed to create Razorpay order');
//         }

//         const options = {
//             key: data.key,
//             amount: data.amount,
//             currency: data.currency,
//             name: 'Your Shop Name',
//             description: 'Order Payment',
//             order_id: data.order_id,
//             handler: async function (response) {
//                 try {
//                     const verifyResponse = await fetch('/verify-razorpay-payment', {
//                         method: 'POST',
//                         headers: { 'Content-Type': 'application/json' },
//                         body: JSON.stringify({
//                             razorpay_payment_id: response.razorpay_payment_id,
//                             razorpay_order_id: response.razorpay_order_id,
//                             razorpay_signature: response.razorpay_signature
//                         })
//                     });
//                     const verifyData = await verifyResponse.json();
                    
//                     if (!verifyData.success) {
//                         throw new Error(verifyData.message || 'Payment verification failed');
//                     }

//                     const checkoutResponse = await fetch('/checkout/online-payment', {
//                         method: 'POST',
//                         headers: { 'Content-Type': 'application/json' },
//                         body: JSON.stringify({
//                             razorpay_payment_id: response.razorpay_payment_id,
//                             razorpay_order_id: response.razorpay_order_id,
//                             razorpay_signature: response.razorpay_signature,
//                             addressId: document.getElementById('selectedAddressId').value
//                         })
//                     });
//                     const checkoutData = await checkoutResponse.json();

//                     if (checkoutData.success) {
//                         window.location.href = `/order-success?orderId=${checkoutData.orderId}`;
//                     } else {
//                         throw new Error(checkoutData.message || 'Checkout process failed');
//                     }
//                 } catch (error) {
//                     console.error('Error processing payment:', error);
//                     alert('Payment failed: ' + error.message);
//                 }
//             },
//             prefill: {
//                 name: 'Customer Name',
//                 email: 'customer@example.com',
//                 contact: '9999999999'
//             },
//             theme: {
//                 color: '#F37254'
//             }
//         };

//         const paymentObject = new Razorpay(options);
//         paymentObject.open();
//     } catch (error) {
//         console.error('Error initializing Razorpay:', error);
//         alert('Failed to initiate payment: ' + error.message);
//     }
// }
async function handleRazorpayPayment(totalAmount) {
    try {
        // Log the total amount being sent
        console.log('Total Amount for Razorpay:', totalAmount);
        
        const response = await fetch('/create-razorpay-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ totalAmount })
        });
        
        // Log the response from the server
        const data = await response.json();
        console.log('Razorpay Order Response:', data);

        if (!data.success) throw new Error(data.message || 'Failed to create Razorpay order');

        const options = {
            key: data.key, // Use the key from the server response
            amount: data.amount, // Amount in paise
            currency: data.currency,
            name: 'ShoeSea',
            description: 'Order Payment',
            order_id: data.order_id,
            handler: async function (response) {
                try {
                    const verifyResponse = await fetch('/verify-razorpay-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    });
                    
                    const verifyData = await verifyResponse.json();
                    console.log('Payment Verification Response:', verifyData);

                    if (!verifyData.success) throw new Error(verifyData.message || 'Payment verification failed');

                    const checkoutResponse = await fetch('/checkout/online-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            addressId: document.getElementById('selectedAddressId').value
                        })
                    });

                    const checkoutData = await checkoutResponse.json();
                    console.log('Checkout Response:', checkoutData);

                    if (checkoutData.success) {
                        window.location.href = `/order-success?orderId=${checkoutData.orderId}`;
                    } else {
                        throw new Error(checkoutData.message || 'Checkout process failed');
                    }
                } catch (error) {
                    console.error('Error processing payment:', error);
                    alert('Payment failed: ' + error.message);
                }
            },
            prefill: {
                name: 'Customer Name',
                email: 'customer@example.com',
                contact: '9999999999'
            },
            theme: {
                color: '#F37254'
            }
        };

        const paymentObject = new Razorpay(options);
        paymentObject.open();
    } catch (error) {
        console.error('Error initializing Razorpay:', error);
        alert('Failed to initiate payment: ' + error.message);
    }
}


// function validateAddressSelection() {
//     const selectedAddressId = document.getElementById('selectedAddressId').value;
//     if (!selectedAddressId) {
//         alert('Please select an address before placing the order.');
//         return false;
//     }

//     const form = document.getElementById('checkoutForm');
//     const paymentMethod = form.querySelector('input[name="paymentMethod"]:checked').value;
    
//     if (paymentMethod === 'Cash on Delivery') {
//         form.action = '/checkout/cod';
//     } else if (paymentMethod === 'Razorpay') {
//         form.action = '#';
//         handleRazorpayPayment(form.querySelector('input[name="totalAmount"]').value);
//         return false;
//     }

//     return true;
// }
function validateAddressSelection() {
    const selectedAddressId = document.getElementById('selectedAddressId').value;
    if (!selectedAddressId) {
        alert('Please select an address before placing the order.');
        return false;
    }

    const form = document.getElementById('checkoutForm');
    const paymentMethod = form.querySelector('input[name="paymentMethod"]:checked').value;
    
    if (paymentMethod === 'Cash on Delivery') {
        // Allow the form to submit normally for COD
        form.action = '/checkout/cod';
        return true;
    } else if (paymentMethod === 'Razorpay') {
        // Handle Razorpay asynchronously
        handleRazorpayPayment(form.querySelector('input[name="totalAmount"]').value);
        return false; // Prevent the form from submitting
    }

    return false; // Ensure form doesn't submit until necessary
}

    </script>
</body>
</html>
