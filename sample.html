
const getAdminDashboard = async (req, res) => {
    try {
        if (!req.session.isAuth || !req.session.adminId) {
            return res.redirect('/admin/login');
        }

        const { filter, startDate: queryStartDate, endDate: queryEndDate } = req.query;
        let startDate, endDate;

         // Set date range based on filter type
         switch (filter) {
            case 'daily':
                startDate = new Date();
                startDate.setDate(startDate.getDate() - 30); // Last 30 days
                endDate = new Date();
                break;
            case 'weekly':
                startDate = new Date();
                startDate.setDate(startDate.getDate() - 7 * 12); // Last 12 weeks
                endDate = new Date();
                break;
            case 'monthly':
                startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 12); // Last 12 months
                endDate = new Date();
                break;
            case 'yearly':
                startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 5); // Last 5 years
                endDate = new Date();
                break;
            case 'custom':
                startDate = new Date(queryStartDate || '2024-01-01');
                endDate = new Date(queryEndDate || Date.now());
                break;
            default:
                startDate = new Date('2024-01-01');
                endDate = new Date();
        }

        // Existing aggregations (topProducts, topCategories, topBrands) remain unchanged
  // Top 10 Products aggregation (unchanged)
        const topProducts = await Order.aggregate([
            { $match: { orderDate: { $gte: startDate, $lte: endDate } } },
            { $unwind: "$products" },
            {
                $group: {
                    _id: "$products.productId",
                    totalSold: { $sum: "$products.quantity" }
                }
            },
            {
                $lookup: {
                    from: 'products',
                    localField: '_id',
                    foreignField: '_id',
                    as: 'product'
                }
            },
            { $unwind: "$product" },
            {
                $project: {
                    productName: "$product.productName",
                    totalSold: 1
                }
            },
            { $sort: { totalSold: -1 } },
            { $limit: 10 }
        ]);

        // Top 10 Categories aggregation (unchanged)
        const topCategories = await Order.aggregate([
            { $match: { orderDate: { $gte: startDate, $lte: endDate } } },
            { $unwind: "$products" },
            {
                $lookup: {
                    from: 'products',
                    localField: 'products.productId',
                    foreignField: '_id',
                    as: 'productDetails'
                }
            },
            { $unwind: "$productDetails" },
            {
                $lookup: {
                    from: 'categories',
                    localField: 'productDetails.categoryId',
                    foreignField: '_id',
                    as: 'categoryDetails'
                }
            },
            { $unwind: "$categoryDetails" },
            {
                $group: {
                    _id: "$categoryDetails._id",
                    categoryName: { $first: "$categoryDetails.categoryName" },
                    totalSales: { $sum: "$products.quantity" }
                }
            },
            { $sort: { totalSales: -1 } },
            { $limit: 10 }
        ]);

        // Top 10 Brands aggregation (unchanged)
        const topBrands = await Order.aggregate([
            { $match: { orderDate: { $gte: startDate, $lte: endDate } } },
            { $unwind: "$products" },
            {
                $lookup: {
                    from: 'products',
                    localField: 'products.productId',
                    foreignField: '_id',
                    as: 'brandDetails'
                }
            },
            { $unwind: "$brandDetails" },
            {
                $group: {
                    _id: "$brandDetails.brand",
                    brandName: { $first: "$brandDetails.brand" },
                    totalSales: { $sum: "$products.quantity" }
                }
            },
            { $sort: { totalSales: -1 } },
            { $limit: 10 }
        ]);

       
        // Sales chart data aggregation based on the filter (sum of products.quantity)
        let salesChartData = [];
        switch (filter) {
            case 'daily':
                salesChartData = await Order.aggregate([
                    { $match: { orderDate: { $gte: startDate, $lte: endDate } } },
                    { $unwind: "$products" }, // Unwind products to access each one
                    {
                        $group: {
                            _id: { $dateToString: { format: "%Y-%m-%d", date: "$orderDate" } },
                            totalQuantity: { $sum: "$products.quantity" } // Sum of product quantities
                        }
                    },
                    { $sort: { "_id": 1 } }
                ]);
                break;
            case 'weekly':
                salesChartData = await Order.aggregate([
                    { $match: { orderDate: { $gte: startDate, $lte: endDate } } },
                    { $unwind: "$products" }, // Unwind products to access each one
                    {
                        $group: {
                            _id: { 
                                year: { $year: "$orderDate" },
                                week: { $week: "$orderDate" }
                            },
                            totalQuantity: { $sum: "$products.quantity" } // Sum of product quantities
                        }
                    },
                    { $sort: { "_id.year": 1, "_id.week": 1 } }
                ]);
                break;
            case 'monthly':
                salesChartData = await Order.aggregate([
                    { $match: { orderDate: { $gte: startDate, $lte: endDate } } },
                    { $unwind: "$products" }, // Unwind products to access each one
                    {
                        $group: {
                            _id: { 
                                year: { $year: "$orderDate" },
                                month: { $month: "$orderDate" }
                            },
                            totalQuantity: { $sum: "$products.quantity" } // Sum of product quantities
                        }
                    },
                    { $sort: { "_id.year": 1, "_id.month": 1 } }
                ]);
                break;
            case 'yearly':
                salesChartData = await Order.aggregate([
                    { $match: { orderDate: { $gte: startDate, $lte: endDate } } },
                    { $unwind: "$products" }, // Unwind products to access each one
                    {
                        $group: {
                            _id: { $year: "$orderDate" },
                            totalQuantity: { $sum: "$products.quantity" } // Sum of product quantities
                        }
                    },
                    { $sort: { "_id": 1 } }
                ]);
                break;
        }

        // Format the sales chart data for frontend
        const formattedSalesChartData = salesChartData.map(item => {
            let label;
            switch (filter) {
                case 'daily':
                    label = new Date(item._id).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    break;
                case 'weekly':
                    label = `W${item._id.week} ${item._id.year}`;
                    break;
                case 'monthly':
                    label = new Date(item._id.year, item._id.month - 1, 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    break;
                case 'yearly':
                    label = item._id.toString();
                    break;
            }
            return {
                label: label,
                value: item.totalQuantity || 0
            };
        });

        // Render the data to the view
        res.render('dashboard', {
            topProducts,
            topCategories,
            topBrands,
            startDate,
            endDate,
            filter,
            salesChartData: formattedSalesChartData
        });


    } catch (err) {
        console.error("Error loading dashboard:", err);
        res.status(500).send('Internal Server Error');
    }
};
